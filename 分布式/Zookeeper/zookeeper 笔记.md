# ZooKeeper 笔记

## 一、什么是 ZooKeeper

**ZooKeeper 是一个典型的分布式数据一致性解决方案，分布式应用程序可以基于 ZooKeeper 实现诸如数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master 选举、分布式锁和分布式队列等功能。**

**ZooKeeper 最常用的使用场景之一是作为服务注册中心。** 服务生产者将自己提供的服务注册到 ZooKeeper，服务消费者在调用服务时，先从 ZooKeeper 中查找服务，获取服务生产者的详细信息后，再进行调用。

------

## 二、ZooKeeper 的重要概念

### 2.1 重要概念总结

- **分布式程序：** ZooKeeper 本身是一个分布式程序（只要半数以上节点存活，ZooKeeper 就能正常服务）。
- **高可用：** 为了保证高可用，ZooKeeper 通常以集群形态部署，能容忍一定数量的机器故障。
- **内存存储：** ZooKeeper 将数据存储在内存中，保证了高吞吐量和低延迟，但存储容量受内存限制。
- **高性能：** 在“读多于写”的应用场景中性能尤为出色，因为写操作需要服务器间的状态同步。
- **节点类型：** ZooKeeper 提供持久节点和临时节点。临时节点的生命周期与客户端会话绑定，持久节点需要显式移除。
- **核心功能：** 提供数据存储/读取和节点监听服务。

### 2.2 会话（Session）

- **定义：** Session 是 ZooKeeper 服务器与客户端之间的会话，基于 TCP 长连接。
- **生命周期：** 会话开始于连接建立，客户端通过心跳保持会话有效，并可发送请求和接收 Watch 事件通知。
- **超时设置：** `sessionTimeout` 定义了会话超时时间，断开连接后只要在超时时间内重连，会话仍然有效。
- **SessionID：** 每个会话都有唯一的 SessionID，许多机制基于此实现。

### 2.3 ZNode

- **定义：** ZooKeeper 数据模型的基本单元，类似文件系统中的节点。
- **数据模型：** ZNode 以树状结构组织，每个节点路径以 `/` 分隔，例如 `/foo/path1`。
- 节点类型：
  - **持久节点：** 一旦创建，除非显式移除，否则节点永久存在。
  - **临时节点：** 生命周期与客户端会话绑定，会话失效时被删除。
  - **有序节点：** 节点名后自动追加一个由父节点维护的自增数字。
- **属性：** 每个 ZNode 保存数据和元数据，包括版本号等。

### 2.4 版本

- 版本类型：

   每个 ZNode 维护以下版本信息：

  - `version`：当前 ZNode 的版本。
  - `cversion`：子节点的版本。
  - `aversion`：ACL 的版本。

- **用途：** 版本号在控制并发写操作和实现条件更新中非常重要。

### 2.5 Watcher

- **定义：** Watcher 是 ZooKeeper 的事件监听机制。
- **机制：** 用户可在指定节点注册 Watcher，特定事件触发时，服务端通知客户端。
- **用途：** 实现分布式协调服务的重要特性。

### 2.6 ACL

- **定义：** ZooKeeper 使用 ACL（Access Control Lists）控制权限，类似于 UNIX 文件系统。
- 权限类型：
  - CREATE：创建子节点。
  - READ：获取节点数据和子节点列表。
  - WRITE：更新节点数据。
  - DELETE：删除子节点。
  - ADMIN：设置节点的 ACL。
- **子节点控制：** CREATE 和 DELETE 权限专用于子节点操作。

------

## 三、ZooKeeper 的特点

- **顺序一致性：** 同一客户端的事务请求按照严格的顺序应用。
- **原子性：** 事务要么被集群中的所有节点应用，要么完全不被应用。
- **单一系统映像：** 客户端无论连接到哪台服务器，看到的数据一致。
- **可靠性：** 一旦事务被应用，其结果会被持久化，直到下次覆盖。

------

## 四、ZooKeeper 默认端口

```ini
2181：为客户端提供服务。
3888：用于 Leader 选举。
2888：用于集群内机器通信（Leader 监听此端口）。
```
