# limit_req_zone 和 limit_conn_zone 的区别

`limit_req_zone` 和 `limit_conn_zone` 是 Nginx 的限流模块指令，但它们的作用和使用场景不同：

------

## **limit_req_zone**

用于针对 **单个 IP** 的请求数进行限速。它统计单个 IP 的请求处理速率，如果超过设置的限制，就会返回错误。

### 特点：

- **基于请求速率**：控制单位时间内的请求次数。
- **粒度为单个 IP**：每个 IP 独立计数。
- **适合突发流量**：支持设置突发请求（burst）缓冲。
- **需要内存区域**：存储每个 IP 的计数数据。
- **复杂规则支持**：可以基于变量（如 IP、URI）设置限速规则。

### 适用场景：

- 防止单个 IP 的高频请求。
- 控制 API 调用的速率，避免短时间内被滥用。

------

## **limit_conn_zone**

用于限制整个服务器的最大连接数。它控制的是一个全局计数器，与客户端 IP 无关。

### 特点：

- **基于连接数**：限制同时存在的连接数量。
- **全局粒度**：与客户端 IP 无关，是一个全局的连接计数。
- **持续连接限制**：更适合对长时间占用的连接进行限制。
- **无需额外存储**：只使用单个计数器。
- **规则简单**：只能设置全局连接上限，无法支持复杂的限制规则。

### 适用场景：

- 控制服务器资源占用，防止超出负载能力。
- 限制 WebSocket 或长连接的并发数。

------

## **主要区别**

| 特性             | **limit_req_zone**       | **limit_conn_zone**                     |
| ---------------- | ------------------------ | --------------------------------------- |
| **限流维度**     | 单个 IP 的请求速率       | 全局连接数                              |
| **适用流量类型** | 短时间内的突发流量       | 长时间持续连接                          |
| **规则复杂度**   | 支持复杂限速规则         | 规则简单，只能限制连接数                |
| **存储需求**     | 需要内存区域存储 IP 数据 | 无额外存储需求，只使用计数器            |
| **适用场景**     | API 调用、单 IP 限速     | 长连接限制（如 WebSocket、HTTP 长连接） |

------

## **综合使用建议**

- **limit_req_zone**：适用于 **防止单个 IP 短时间内发送大量请求** 的场景，例如 API 防刷。
- **limit_conn_zone**：适用于 **限制服务器总连接数或并发数** 的场景，例如防止服务器过载。
- **配合使用**：可以同时使用两者，全面控制流量和连接，例如对单个 IP 限速的同时，也限制整个服务器的总连接数。

示例配置：

```nginx
# 定义限流区域
limit_req_zone $binary_remote_addr zone=req_zone:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=conn_zone:10m;

server {
    listen 80;

    # 单个 IP 限制请求速率
    limit_req zone=req_zone burst=5 nodelay;

    # 单个 IP 限制并发连接数
    limit_conn conn_zone 20;

    location /api/ {
        proxy_pass http://backend;
    }
}
```